<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>发布文章 - 回声网络</title>
    <style>
        /* 保持你原来的CSS样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f8f9fa; color: #333; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eaeaea; }
        .header h1 { color: #2c3e50; margin-bottom: 10px; font-weight: 600; }
        /* 其他样式保持不变 */
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>发布文章 - 测试版</h1>
        <p>当前应用路径: <span id="currentPath"></span></p >
    </div>

    <div class="message-container" id="messageContainer"></div>

    <div class="form-section">
        <h3 class="form-section-title">第一步：测试路径</h3>
        <button id="testPathBtn">测试应用路径和分类接口</button>
        <div id="testResult"></div>
    </div>

    <div class="form-section">
        <h3 class="form-section-title">第二步：测试分类功能</h3>
        <button id="testCategoryBtn" disabled>测试分类模态框</button>
    </div>

    <!-- 分类模态框 -->
    <div class="modal" id="categoryModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>选择文章分类</h3>
                <button class="close-modal" id="closeCategoryModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalCategories"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCategorySelection">取消</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 自动检测应用上下文路径
    function detectContextPath() {
        const path = window.location.pathname;
        console.log('完整路径:', path);

        // 常见的路径模式
        const patterns = [
            /^\/([^\/]+)\/.*$/,  // /appName/path
            /^\/.*$/             // 根路径
        ];

        for (let pattern of patterns) {
            const match = path.match(pattern);
            if (match && match[1]) {
                return '/' + match[1];
            }
        }

        return ''; // 根路径
    }

    const CONTEXT_PATH = detectContextPath();
    console.log('检测到的应用上下文路径:', CONTEXT_PATH);

    // 更新页面显示
    document.getElementById('currentPath').textContent = CONTEXT_PATH || '/ (根路径)';

    // 测试路径功能
    document.getElementById('testPathBtn').addEventListener('click', async function() {
        const testResult = document.getElementById('testResult');
        testResult.innerHTML = '<p>测试中...</p >';

        try {
            // 测试分类接口
            const categoryUrl = CONTEXT_PATH + '/category/list';
            console.log('测试URL:', categoryUrl);

            const response = await fetch(categoryUrl);
            console.log('响应状态:', response.status, response.statusText);

            if (response.ok) {
                const categories = await response.json();
                testResult.innerHTML = `
                <div style="color: green; margin: 10px 0;">
                    ✅ 路径测试成功！<br>
                    接口URL: ${categoryUrl}<br>
                    获取到 ${categories.length} 个分类
                </div>
            `;
                document.getElementById('testCategoryBtn').disabled = false;
            } else {
                testResult.innerHTML = `
                <div style="color: red; margin: 10px 0;">
                    ❌ 路径测试失败 (${response.status})<br>
                    尝试的URL: ${categoryUrl}<br>
                    建议检查：<br>
                    1. 应用是否已启动<br>
                    2. CategoryController 是否正确部署<br>
                    3. 应用上下文路径是否正确
                </div>
            `;
            }
        } catch (error) {
            testResult.innerHTML = `
            <div style="color: red; margin: 10px 0;">
                ❌ 请求失败: ${error.message}<br>
                尝试的URL: ${CONTEXT_PATH + '/category/list'}<br>
                可能的原因：<br>
                1. 服务器未启动<br>
                2. 跨域问题<br>
                3. 网络连接问题
            </div>
        `;
        }
    });

    // 测试分类功能
    document.getElementById('testCategoryBtn').addEventListener('click', function() {
        const modal = document.getElementById('categoryModal');
        modal.style.display = 'block';
        loadCategoriesForTest();
    });

    document.getElementById('closeCategoryModal').addEventListener('click', function() {
        document.getElementById('categoryModal').style.display = 'none';
    });

    document.getElementById('cancelCategorySelection').addEventListener('click', function() {
        document.getElementById('categoryModal').style.display = 'none';
    });

    // 点击模态框外部关闭
    document.getElementById('categoryModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });

    // 加载分类数据
    async function loadCategoriesForTest() {
        try {
            const response = await fetch(CONTEXT_PATH + '/category/list');
            const categories = await response.json();

            const container = document.getElementById('modalCategories');
            container.innerHTML = '';

            if (categories.length === 0) {
                container.innerHTML = '<p>暂无分类</p >';
                return;
            }

            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-item';
                div.style.cssText = 'padding: 10px; border: 1px solid #ddd; margin: 5px; cursor: pointer;';
                div.innerHTML = `
                <strong>${category.name}</strong>
                <br>
                <small>${category.description || '暂无描述'}</small>
            `;

                div.addEventListener('click', function() {
                    alert(`选择了分类: ${category.name} (ID: ${category.id})`);
                    document.getElementById('categoryModal').style.display = 'none';
                });

                container.appendChild(div);
            });

        } catch (error) {
            document.getElementById('modalCategories').innerHTML =
                `<p style="color: red;">加载分类失败: ${error.message}</p >`;
        }
    }

    // 显示消息
    function showMessage(text, type) {
        const container = document.getElementById('messageContainer');
        const message = document.createElement('div');
        message.className = `message ${type}`;
        message.style.cssText = 'padding: 10px; margin: 10px 0; border-radius: 4px;';
        message.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
        message.style.color = type === 'error' ? '#721c24' : '#155724';
        message.textContent = text;

        container.appendChild(message);

        setTimeout(() => {
            if (message.parentNode === container) {
                message.remove();
            }
        }, 5000);
    }
</script>
</body>
</html> '